{% extends "base.html" %}

{% block content %}
<section class="page-header">
    <div class="page-title">
        <h1>{{ topic.name }}</h1>
        <p>Add questions with links, track difficulty, and mark revisions when you revisit them.</p>
    </div>
    <div class="hero-actions">
        <a href="{{ url_for('routes.topics') }}" class="btn secondary">Back to Topics</a>
        <a href="{{ url_for('routes.add_question', topic_id=topic.id) }}" class="btn">Add Question</a>
    </div>
</section>

<form method="get" class="card filter-bar">
    <div>
        <label for="difficulty">Difficulty</label>
        <select name="difficulty" id="difficulty">
            <option value="" {% if not selected_difficulty %}selected{% endif %}>All</option>
            <option value="Easy" {% if selected_difficulty == "Easy" %}selected{% endif %}>Easy</option>
            <option value="Medium" {% if selected_difficulty == "Medium" %}selected{% endif %}>Medium</option>
            <option value="Hard" {% if selected_difficulty == "Hard" %}selected{% endif %}>Hard</option>
        </select>
    </div>
    <div>
        <label for="search">Search</label>
        <input type="text" id="search" name="search" placeholder="Search question..." value="{{ search_query }}">
    </div>
    <div style="align-self: end;">
        <button type="submit">Filter</button>
    </div>
</form>

{% if questions %}
    <div class="card table-card">
        <table class="question-table">
            <thead>
                <tr>
                    <th>Revisions</th>
                    <th>Title</th>
                    <th>Notes</th>
                    <th>Difficulty</th>
                    <th>Link</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for q in questions %}
                <tr>
                    <td>
                        <div class="revision-counter" data-toggle-url="{{ url_for('routes.toggle_question', question_id=q.id) }}">
                            <button type="button" class="btn secondary icon-btn js-revision-dec" aria-label="Decrease revision count">-</button>
                            <span class="revision-count js-revision-count">{{ q.revision_count or 0 }}</span>
                            <button type="button" class="btn icon-btn js-revision-inc" aria-label="Increase revision count">+</button>
                        </div>
                    </td>
                    <td>{{ q.title }}</td>
                    <td>
                        <div class="question-notes">
                            <p><strong>Mistake:</strong> {{ q.mistake if q.mistake else "-" }}</p>
                            <p><strong>Takeaway:</strong> {{ q.takeaway if q.takeaway else "-" }}</p>
                        </div>
                    </td>
                    <td>
                        <span class="badge {{ q.difficulty | lower }}">{{ q.difficulty }}</span>
                    </td>
                    <td>
                        <a class="btn secondary" href="{{ q.link }}" target="_blank">Open</a>
                    </td>
                    <td>
                        <div class="question-actions">
                            <a href="{{ url_for('routes.edit_question', question_id=q.id) }}" class="btn secondary small">Edit</a>
                            <form method="post" action="{{ url_for('routes.delete_question', question_id=q.id) }}" onsubmit="return confirm('Delete this question? This cannot be undone.');">
                                <button type="submit" class="btn danger icon-btn" aria-label="Delete question">-</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="empty-state">
        <div class="badge">No questions yet</div>
        <h2>Save your first question link</h2>
        <p>Collect problem links, add notes, and keep revisions in one place.</p>
        <div class="hero-actions" style="justify-content: center;">
            <a href="{{ url_for('routes.add_question', topic_id=topic.id) }}" class="btn">Add a question</a>
        </div>
    </div>
{% endif %}
<script>
    document.querySelectorAll(".revision-counter").forEach((counter) => {
        const toggleUrl = counter.dataset.toggleUrl;
        const countEl = counter.querySelector(".js-revision-count");
        const decBtn = counter.querySelector(".js-revision-dec");
        const incBtn = counter.querySelector(".js-revision-inc");

        const updateCount = async (action) => {
            if (!toggleUrl || !countEl) {
                return;
            }

            const currentValue = Number.parseInt(countEl.textContent, 10) || 0;
            const nextValue = action === "increment"
                ? currentValue + 1
                : Math.max(0, currentValue - 1);
            countEl.textContent = nextValue;

            try {
                const response = await fetch(toggleUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action })
                });
                if (!response.ok) {
                    throw new Error("Request failed");
                }
            } catch (error) {
                countEl.textContent = currentValue;
                alert("Could not save revision count. Please try again.");
            }
        };

        decBtn?.addEventListener("click", () => updateCount("decrement"));
        incBtn?.addEventListener("click", () => updateCount("increment"));
    });
</script>
{% endblock %}
